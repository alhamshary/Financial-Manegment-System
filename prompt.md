
# مطالبة بناء: نظام إدارة الهمشري

## 1. نظرة عامة على المشروع

الهدف هو بناء تطبيق ويب داخلي شامل لشركة "الهمشري"، مصمم لإدارة العمليات اليومية. التطبيق عبارة عن لوحة تحكم تعتمد على الأدوار (مسؤول، مشرف، موظف) مع واجهة مستخدم كاملة باللغة العربية وتصميم يدعم الكتابة من اليمين إلى اليسار (RTL).

**الميزات الأساسية:**
- نظام مصادقة آمن.
- لوحات تحكم مخصصة حسب دور المستخدم.
- إدارة الخدمات والعملاء والمصاريف.
- تتبع حضور الموظفين وأوقات العمل.
- إنشاء تقارير مفصلة.
- إعدادات تطبيق قابلة للتخصيص.

---

## 2. المكدس التقني

- **إطار العمل:** Next.js مع App Router
- **اللغة:** TypeScript
- **مكونات واجهة المستخدم:** shadcn/ui
- **التصميم:** Tailwind CSS
- **قاعدة البيانات والمصادقة:** Supabase
- **إدارة الحالة:** React Context API (للمصادقة)
- **الأيقونات:** lucide-react
- **النماذج:** React Hook Form مع Zod (للتحقق من الصحة)

---

## 3. مخطط قاعدة بيانات Supabase

يجب إعداد الجداول التالية في Supabase. يجب تمكين أمان على مستوى الصف (RLS) لضمان أن المستخدمين يمكنهم الوصول إلى البيانات المسموح لهم بها فقط.

- **`users`**: يخزن معلومات المستخدمين.
  - `id` (uuid, مفتاح أساسي, مرتبط بـ `auth.users.id`)
  - `name` (text)
  - `email` (text)
  - `role` (text: 'admin', 'manager', 'employee')

- **`services`**: قائمة بالخدمات التي تقدمها الشركة.
  - `id` (serial, مفتاح أساسي)
  - `name` (text)
  - `category` (text, nullable)
  - `price` (numeric)
  - `link` (text, nullable)

- **`clients`**: يخزن معلومات العملاء.
  - `id` (serial, مفتاح أساسي)
  - `name` (text)
  - `phone` (text, unique)

- **`orders`**: يسجل كل خدمة مقدمة لعميل.
  - `id` (serial, مفتاح أساسي)
  - `user_id` (uuid, مفتاح خارجي إلى `users.id`)
  - `service_id` (integer, مفتاح خارجي إلى `services.id`)
  - `client_id` (integer, مفتاح خارجي إلى `clients.id`)
  - `price` (numeric)
  - `quantity` (integer)
  - `discount` (numeric, default 0)
  - `total` (numeric)
  - `payment_method` (enum: 'cash', 'wallet')
  - `notes` (text, nullable)
  - `created_at` (timestampz, default now())

- **`expenses`**: يسجل المصاريف.
  - `id` (serial, مفتاح أساسي)
  - `name` (text)
  - `amount` (numeric)
  - `user_id` (uuid, مفتاح خارجي إلى `users.id`)
  - `created_at` (timestampz, default now())

- **`attendance`**: يتتبع جلسات عمل الموظفين.
  - `id` (serial, مفتاح أساسي)
  - `user_id` (uuid, مفتاح خارجي إلى `users.id`)
  - `work_date` (date)
  - `check_in` (timestamptz)
  - `check_out` (timestamptz, nullable)
  - `session_duration` (integer, دقائق, nullable)

- **`app_settings`**: يخزن إعدادات التطبيق العامة.
  - `id` (boolean, مفتاح أساسي, default true)
  - `office_title` (text)
  - `app_theme` (text)

### وظائف قاعدة البيانات (RPC)

- **`auto_start_attendance(user_id_param uuid)`**:
  - يتم استدعاؤها عند تسجيل دخول المستخدم.
  - تتحقق مما إذا كان هناك سجل حضور مفتوح (`check_out` هو null) لهذا المستخدم في `work_date` الحالي.
  - إذا لم يكن هناك سجل مفتوح، تقوم بإنشاء سجل جديد مع `check_in` الحالي.

- **`end_current_attendance(user_id_param uuid)`**:
  - يتم استدعاؤها عند تسجيل خروج المستخدم.
  - تبحث عن سجل الحضور المفتوح للمستخدم (`check_out` هو null).
  - إذا وجد، تقوم بتعيين `check_out` إلى الوقت الحالي وتحسب `session_duration` بالدقائق.

---

## 4. تفاصيل تنفيذ الصفحات والمكونات

### 4.1. المصادقة والحالة العامة (`auth-provider.tsx`)
- إنشاء `AuthProvider` باستخدام React Context.
- يجب أن يدير حالة المستخدم (بما في ذلك الدور)، حالة التحميل، وإعدادات التطبيق.
- عند تحميل التطبيق، يجب أن:
  1. يتحقق من جلسة المصادقة مع Supabase.
  2. إذا كان هناك مستخدم، يجلب ملفه الشخصي من جدول `users`.
  3. يجلب إعدادات التطبيق من جدول `app_settings`.
  4. يستدعي `auto_start_attendance` في الخلفية.
- يجب أن يوفر وظائف `login` و `logout`.
- وظيفة `logout` يجب أن تستدعي `end_current_attendance` قبل تسجيل الخروج.

### 4.2. التخطيط العام (`app-layout.tsx` و `main-nav.tsx`)
- `AppLayout` هو المكون الذي يغلف جميع الصفحات المحمية.
- يعرض شاشة تحميل حتى يتم التحقق من المصادقة.
- يتحقق من أدوار المستخدمين ويمنع الوصول إلى الصفحات غير المصرح بها.
- يحتوي على شريط جانبي (Sidebar) ورأس (Header).
- الرأس يعرض عنوان المكتب (من `app_settings`) وقائمة منسدلة للمستخدم.
- الشريط الجانبي (`MainNav`) يعرض روابط التنقل بناءً على دور المستخدم:
  - **الجميع:** لوحة التحكم، إرسال خدمة، المصاريف.
  - **المشرف/المسؤول:** الخدمات، التقارير، الحضور.
  - **المسؤول فقط:** الفريق، الإعدادات.

### 4.3. صفحة تسجيل الدخول (`/page.tsx`)
- تعرض نموذج تسجيل دخول بسيط (البريد الإلكتروني وكلمة المرور).
- تعرض عنوان التطبيق العام.
- عند تسجيل الدخول بنجاح، تعيد التوجيه إلى `/dashboard`.

### 4.4. لوحة التحكم (`/dashboard`)
- تعرض بطاقات ملخص وإحصاءات بناءً على دور المستخدم.
- **عرض الموظف:**
  - بطاقة تعرض وقت بدء الجلسة (`check_in`).
  - بطاقات لإجمالي إيرادات الموظف *اليوم*، إجمالي مصاريفه *اليوم*، وصافي المبلغ.
  - جدول يعرض الخدمات التي قدمها الموظف *اليوم*.
- **عرض المسؤول/المشرف:**
  - بطاقة وقت بدء الجلسة.
  - بطاقات ملخصة لإجمالي الإيرادات، المصاريف، صافي الربح، عدد الخدمات المباعة، عدد الموظفين النشطين، ومتوسط ساعات العمل لـ *اليوم*.
  - جدول يعرض *جميع* الخدمات المقدمة من *جميع* الموظفين *اليوم*.

### 4.5. صفحة إرسال خدمة (`/submit-service`)
- نموذج لإدخال تفاصيل خدمة مكتملة.
- **الحقول:**
  - **الخدمة:** مربع بحث منسدل (Combobox) للبحث في جدول `services`.
  - **اسم العميل:** حقل إدخال.
  - **هاتف العميل:** حقل إدخال.
  - **الكمية:** حقل رقمي.
  - **الخصم:** حقل رقمي.
  - **طريقة الدفع:** قائمة منسدلة (كاش، محفظة).
  - **ملاحظات:** حقل نصي.
- يعرض السعر النهائي المحسوب ديناميكيًا.
- عند الإرسال، يبحث عن العميل بالهاتف أو ينشئ عميلاً جديدًا، ثم ينشئ سجلاً في جدول `orders`.

### 4.6. صفحة المصاريف (`/expenses`)
- لعرض وإدارة المصاريف.
- **عرض الموظف:** يرى فقط مصاريفه لليوم الحالي.
- **عرض المسؤول/المشرف:** يرى جميع المصاريف مع فلاتر حسب الموظف والنطاق الزمني.
- زر "إضافة مصروف" يفتح نافذة حوارية (Dialog) تحتوي على نموذج (`ExpenseForm`) لإضافة مصروف جديد (الاسم، المبلغ).
- يمكن تعديل وحذف المصاريف (مع نافذة تأكيد).

### 4.7. صفحة الخدمات (`/services`) (المسؤول/المشرف)
- لإدارة قائمة الخدمات.
- تعرض جميع الخدمات في جدول (الاسم، الفئة، السعر، الرابط).
- زر "إضافة خدمة" يفتح نافذة حوارية (`ServiceForm`).
- القدرة على تعديل وحذف الخدمات.

### 4.8. صفحة التقارير (`/reports`) (المسؤول/المشرف)
- تعرض تقارير إيرادات مفصلة.
- بطاقات ملخصة (إجمالي الإيرادات، المصاريف، صافي الربح، عدد الخدمات) بناءً على الفلاتر.
- **الفلاتر:** نطاق زمني، موظف، خدمة.
- جدول يعرض السجلات المطابقة للفلاتر.
- زر "تصدير كـ CSV".

### 4.9. صفحة الحضور (`/attendance`) (المسؤول/المشرف)
- تعرض تقرير حضور الموظفين.
- يتم تجميع البيانات لعرض إجمالي ساعات العمل لكل موظف في كل يوم.
- **الفلاتر:** نطاق زمني، موظف.
- زر "تصدير كـ CSV".

### 4.10. صفحة الفريق (`/team`) (المسؤول)
- لإدارة المستخدمين.
- تعرض قائمة بجميع المستخدمين (الصورة الرمزية، الاسم، البريد الإلكتروني، الدور).
- زر "إضافة مستخدم" يفتح نافذة حوارية (`UserForm`) لإنشاء مستخدم جديد (بما في ذلك تعيين كلمة مرور) في Supabase Auth وجدول `users`.
- القدرة على تعديل دور المستخدم وحذف المستخدمين.

### 4.11. صفحة الإعدادات (`/settings`) (المسؤول)
- لإدارة إعدادات التطبيق العامة.
- حقل لتغيير "عنوان المكتب".
- مجموعة أزرار راديو (Radio Group) لتغيير سمة اللون للتطبيق (مثل: افتراضي، وردي، أخضر).
- عند الحفظ، يتم تحديث جدول `app_settings` وتطبيق السمة الجديدة ديناميكيًا باستخدام متغيرات CSS.
